<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment Results - PrivaGene</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/components.css">

    <style>
        .risk-gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto var(--space-xl);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .risk-gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg 108deg,
                    var(--warning-color) 108deg 252deg,
                    var(--error-color) 252deg 360deg);
            padding: 10px;
        }

        .risk-gauge-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .risk-percentage {
            font-size: var(--text-4xl);
            font-weight: 700;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../../index.html"
                style="display: flex; align-items: center; gap: var(--space-sm); text-decoration: none;">
                <span style="font-size: var(--text-3xl);">ğŸ§¬</span>
                <span style="font-size: var(--text-xl); font-weight: 700; color: var(--primary-color);">PrivaGene</span>
            </a>
        </div>

        <div
            style="margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <div style="font-weight: 600; margin-bottom: var(--space-xs);" data-user-name>User</div>
            <div style="font-size: var(--text-sm); color: var(--text-tertiary);" data-user-email>user@example.com</div>
        </div>

        <nav>
            <ul class="sidebar-menu">
                <li class="sidebar-item"><a href="dashboard.html" class="sidebar-link"><span
                            class="sidebar-link-icon">ğŸ“Š</span>Dashboard</a></li>
                <li class="sidebar-item"><a href="upload-gene.html" class="sidebar-link"><span
                            class="sidebar-link-icon">ğŸ“¤</span>Upload Gene Data</a></li>
                <li class="sidebar-item"><a href="disease-selection.html" class="sidebar-link"><span
                            class="sidebar-link-icon">ğŸ§ª</span>Risk Assessment</a></li>
                <li class="sidebar-item"><a href="risk-results.html" class="sidebar-link"><span
                            class="sidebar-link-icon">ğŸ“ˆ</span>My Results</a></li>
                <li class="sidebar-item"><a href="family-access.html" class="sidebar-link">
                        <span class="sidebar-link-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>Family Access</a></li>
                <li class="sidebar-item"><a href="profile.html" class="sidebar-link"><span
                            class="sidebar-link-icon">ğŸ‘¤</span>Profile</a></li>
            </ul>
        </nav>

        <div style="margin-top: auto;"><button id="logout-btn" class="sidebar-link"
                style="width: 100%; border: none; background: transparent; cursor: pointer;"><span
                    class="sidebar-link-icon">ğŸšª</span>Logout</button></div>
    </aside>

    <!-- Main Content -->
    <main class="main-with-sidebar">
        <div class="container">
            <a href="dashboard.html" class="back-link">â† Back to Dashboard</a>

            <div style="margin-bottom: var(--space-2xl); margin-top: var(--space-lg);">
                <h1 style="font-size: var(--text-4xl); font-weight: 700; margin-bottom: var(--space-sm);">Your Risk
                    Assessment Results</h1>
                <p class="text-secondary">Computed on <span id="computedDate"></span></p>
            </div>

            <!-- Overall Risk -->
            <div class="card text-center" style="margin-bottom: var(--space-2xl);">
                <h2 class="card-title">Overall Intersect Score</h2>
                <br>
                <div class="risk-gauge">
                    <div class="risk-gauge-circle">
                        <div class="risk-gauge-inner">
                            <div class="risk-percentage" id="overallRisk">-</div>
                        </div>
                    </div>
                </div>
                <p id="riskDescription" class="text-secondary"></p>
            </div>

            <!-- Individual Results -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Disease-Specific Risk</h3>
                </div>
                <div id="individualResults">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Actions -->
            <div style="margin-top: var(--space-2xl); text-align: center;">
                <div class="flex justify-center gap-lg">
                    <button onclick="window.print()" class="btn btn-outline">ğŸ“„ Download Report</button>
                    <a href="explanation.html" class="btn btn-secondary">ğŸ“– View Detailed Explanation</a>
                    <a href="appointments.html" class="btn btn-primary">ğŸ“… Book Consultation</a>
                </div>
            </div>
        </div>
    </main>

    <script src="../../js/storage.js"></script>
    <script src="../../js/api-backend.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/navigation.js"></script>

    <script>
        Auth.requireRole('patient');
        const user = Auth.getCurrentUser();
        Navigation.displayUserInfo(user);
        Navigation.setActiveNav();

        document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());

        // Cache for disease categories (loaded from database)
        let diseaseCategories = [];

        async function loadDiseaseCategories() {
            try {
                // Fetch from backend database
                diseaseCategories = await API.getDiseaseCategories();
                console.log('Disease categories loaded from database:', diseaseCategories);
            } catch (error) {
                console.error('Failed to load disease categories:', error);
                diseaseCategories = [];
            }
        }

        function getDiseaseName(diseaseId) {
            const disease = diseaseCategories.find(d => d.id === diseaseId);
            return disease ? disease.name : 'Unknown Disease';
        }

        function getHospitalId(diseaseId) {
            const disease = diseaseCategories.find(d => d.id === diseaseId);
            return disease ? disease.hospitalId : 'Unknown';
        }

        function getHospitalName(diseaseId) {
            const disease = diseaseCategories.find(d => d.id === diseaseId);
            return disease ? disease.hospitalName : 'Unknown';
        }

        function getDiseaseCode(diseaseId) {
            const disease = diseaseCategories.find(d => d.id === diseaseId);
            return disease ? disease.diseaseCode : null;
        }

        async function loadResults() {
            try {
                // First load disease categories from database to map IDs to names
                await loadDiseaseCategories();
                
                // Retrieve ALL risk assessments for this user from database
                console.log('=== Fetching risk assessments from database ===');
                const assessments = await API.getRiskAssessments(user.id);
                
                console.log('=== ALL RISK ASSESSMENTS ===');
                console.log('Total assessments found:', assessments.length);
                console.log('Full assessments array:', assessments);
                
                if (assessments.length === 0) {
                    document.querySelector('.container').innerHTML = `
                        <a href="dashboard.html" class="back-link">â† Back to Dashboard</a>
                        <div style="margin-top: var(--space-2xl); text-align: center;">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“Š</div>
                                <div class="empty-state-title">No Risk Assessments Yet</div>
                                <div class="empty-state-description">
                                    You haven't run any risk assessments yet. Upload your genetic data and select diseases to get started.
                                </div>
                                <div style="margin-top: var(--space-xl);">
                                    <a href="disease-selection.html" class="btn btn-primary">Run Risk Assessment</a>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Display all assessments
                displayAllAssessments(assessments);

            } catch (error) {
                console.error('=== ERROR LOADING RESULTS ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Stack trace:', error.stack);
                UI.showAlert('Failed to load results: ' + error.message, 'error');
            }
        }

        function displayAllAssessments(assessments) {
            // Sort by date (most recent first)
            const sortedAssessments = [...assessments].sort((a, b) => {
                const dateA = new Date(a.created_at || a.createdAt);
                const dateB = new Date(b.created_at || b.createdAt);
                return dateB - dateA;
            });

            // Build HTML for all assessment cards
            const assessmentCards = sortedAssessments.map((assessment, index) => {
                const overallRisk = parseFloat(
                    assessment.overallRisk || 
                    assessment.overall_risk || 
                    assessment.riskPercentage || 
                    assessment.risk_percentage || 
                    0
                ).toFixed(2);
                
                const diseaseId = assessment.diseaseId || assessment.disease_id;
                
                // Look up disease name from database-loaded categories
                const diseaseName = getDiseaseName(diseaseId);
                const hospitalName = getHospitalName(diseaseId);
                const diseaseCode = getDiseaseCode(diseaseId);
                
                // Determine risk level and color
                let riskLevel, riskColor;
                if (overallRisk < 30) {
                    riskLevel = 'Low';
                    riskColor = 'var(--success-color)';
                } else if (overallRisk < 70) {
                    riskLevel = 'Medium';
                    riskColor = 'var(--warning-color)';
                } else {
                    riskLevel = 'High';
                    riskColor = 'var(--error-color)';
                }

                // Parse matched genes if it's a JSON string
                let matchedGenes = assessment.matchedGenes || assessment.matched_genes;
                if (typeof matchedGenes === 'string') {
                    try {
                        matchedGenes = JSON.parse(matchedGenes);
                    } catch (e) {
                        matchedGenes = [];
                    }
                }

                const matchCount = assessment.matchCount || assessment.match_count || 0;
                const geneList = matchedGenes && matchedGenes.length > 0 
                    ? ` Matching genes: ${matchedGenes.join(', ')}.` 
                    : '';

                const createdAt = assessment.createdAt || assessment.created_at;

                return `
                    <div class="card text-center" style="margin-bottom: var(--space-2xl);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-lg);">
                            <div style="text-align: left;">
                                <h2 class="card-title" style="text-align: left;">${diseaseName}</h2>
                                <div class="text-secondary text-sm" style="margin-top: var(--space-xs); text-align: left;">
                                    <span style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">
                                        ğŸ¥ Provider: ${hospitalName}
                                    </span>
                                    ${diseaseCode ? `
                                    <span style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 4px;">
                                        Code: ${diseaseCode}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>
                            <span class="text-secondary text-sm">
                                ${UI.formatDateTime(createdAt)}
                            </span>
                        </div>
                        <h3 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-lg);">
                            Disease Risk Percentage
                        </h3>
                        <div class="risk-gauge">
                            <div class="risk-gauge-circle">
                                <div class="risk-gauge-inner">
                                    <div class="risk-percentage" style="color: ${riskColor};">
                                        ${overallRisk}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-secondary">
                            Your genetic risk for ${diseaseName} is <strong style="color: ${riskColor};">${riskLevel.toLowerCase()}</strong>. 
                            ${matchCount} gene(s) match, resulting in a ${overallRisk}% intersection score.${geneList}
                        </p>
                    </div>
                `;
            }).join('');

            // Update the page content
            const container = document.querySelector('.container');
            container.innerHTML = `
                <a href="dashboard.html" class="back-link">â† Back to Dashboard</a>

                <div style="margin-bottom: var(--space-2xl); margin-top: var(--space-lg);">
                    <h1 style="font-size: var(--text-4xl); font-weight: 700; margin-bottom: var(--space-sm);">
                        Your Risk Assessment Results
                    </h1>
                    <p class="text-secondary">
                        Showing ${sortedAssessments.length} assessment${sortedAssessments.length !== 1 ? 's' : ''}
                    </p>
                </div>

                ${assessmentCards}

                <!-- Actions -->
                <div style="margin-top: var(--space-2xl); text-align: center;">
                    <div class="flex justify-center gap-lg">
                        <button onclick="window.print()" class="btn btn-outline">ğŸ“„ Download Report</button>
                        <a href="disease-selection.html" class="btn btn-primary">ğŸ§ª Run New Assessment</a>
                    </div>
                </div>
            `;

            console.log(`Displayed ${sortedAssessments.length} assessments`);
        }

        loadResults();
    </script>

</body>

</html>