<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Access - PrivaGene</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/components.css">

    <style>
        .family-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            transition: background var(--transition-fast);
        }

        .family-card:hover {
            background: var(--bg-tertiary);
        }

        .family-card:last-child {
            border-bottom: none;
        }

        .family-info {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .family-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-2xl);
            color: white;
            font-weight: 600;
        }

        .family-details h4 {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .family-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-lg);
            font-size: var(--text-sm);
            color: var(--text-tertiary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 500;
        }

        .status-active {
            background: hsla(142, 71%, 45%, 0.1);
            color: var(--success-color);
        }

        .status-pending {
            background: hsla(38, 92%, 50%, 0.1);
            color: var(--warning-color);
        }

        .privacy-notice {
            background: linear-gradient(135deg, hsla(199, 89%, 48%, 0.1), hsla(180, 70%, 50%, 0.1));
            border: 1px solid var(--info-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }

        .privacy-notice h3 {
            color: var(--info-color);
            font-size: var(--text-lg);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .add-caregiver-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--space-md);
            align-items: end;
        }

        @media (max-width: 768px) {
            .add-caregiver-form {
                grid-template-columns: 1fr;
            }
        }

        .permissions-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .permission-tag {
            background: var(--bg-tertiary);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .error-message {
            color: var(--error-color);
            font-size: var(--text-sm);
            margin-top: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: hsla(0, 72%, 51%, 0.1);
            border-radius: var(--radius-md);
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../../index.html" style="display: flex; align-items: center; gap: var(--space-sm); text-decoration: none;">
                <span style="font-size: var(--text-3xl);">üß¨</span>
                <span style="font-size: var(--text-xl); font-weight: 700; color: var(--primary-color);">PrivaGene</span>
            </a>
        </div>

        <div style="margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <div style="font-weight: 600; margin-bottom: var(--space-xs);" data-user-name>User</div>
            <div style="font-size: var(--text-sm); color: var(--text-tertiary);" data-user-email>user@example.com</div>
        </div>

        <nav>
            <ul class="sidebar-menu">
                <li class="sidebar-item"><a href="dashboard.html" class="sidebar-link"><span class="sidebar-link-icon">üìä</span> Dashboard</a></li>
                <li class="sidebar-item"><a href="upload-gene.html" class="sidebar-link"><span class="sidebar-link-icon">üì§</span> Upload Gene Data</a></li>
                <li class="sidebar-item"><a href="disease-selection.html" class="sidebar-link"><span class="sidebar-link-icon">üß™</span> Risk Assessment</a></li>
                <li class="sidebar-item"><a href="risk-results.html" class="sidebar-link"><span class="sidebar-link-icon">üìà</span> My Results</a></li>
                <li class="sidebar-item"><a href="family-access.html" class="sidebar-link"><span class="sidebar-link-icon">üë®‚Äçüë©‚Äçüëß</span> Family Access</a></li>
                <li class="sidebar-item"><a href="profile.html" class="sidebar-link"><span class="sidebar-link-icon">üë§</span> Profile</a></li>
            </ul>
        </nav>

        <div style="margin-top: auto;">
            <button id="logout-btn" class="sidebar-link" style="width: 100%; border: none; background: transparent; cursor: pointer;">
                <span class="sidebar-link-icon">üö™</span> Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-with-sidebar">
        <div class="container-fluid">
            <div style="margin-bottom: var(--space-xl);">
                <h1 style="font-size: var(--text-4xl); font-weight: 700; margin-bottom: var(--space-sm);">Family Access</h1>
                <p class="text-secondary">Allow trusted family members to view your risk assessment results</p>
            </div>

            <!-- Privacy Notice -->
            <div class="privacy-notice">
                <h3>üîí Your Privacy is Protected</h3>
                <p class="text-secondary" style="margin: 0;">
                    Caregivers you add can <strong>only view your risk assessment results</strong>. 
                    They will <strong>never</strong> have access to your raw genetic data, which remains 
                    encrypted and private to you alone. You can revoke access at any time.
                </p>
            </div>

            <!-- Add Caregiver Section -->
            <div class="card" style="margin-bottom: var(--space-2xl);">
                <div class="card-header">
                    <h3 class="card-title">Add a Caregiver</h3>
                </div>
                <form id="addCaregiverForm" class="add-caregiver-form" style="padding: var(--space-lg);">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="caregiverEmail" class="form-label">Caregiver's Email</label>
                        <input type="email" id="caregiverEmail" class="form-input" placeholder="caregiver@email.com" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="relationship" class="form-label">Relationship</label>
                        <select id="relationship" class="form-select" required>
                            <option value="">Select...</option>
                            <option value="spouse">Spouse</option>
                            <option value="child">Son/Daughter</option>
                            <option value="parent">Parent</option>
                            <option value="sibling">Sibling</option>
                            <option value="grandchild">Grandchild</option>
                            <option value="other">Other Family</option>
                            <option value="caregiver">Professional Caregiver</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="height: fit-content;" id="submitBtn">‚ûï Send Invitation</button>
                </form>
                <div id="formError" class="error-message" style="margin: 0 var(--space-lg) var(--space-lg);"></div>
            </div>

            <!-- Active Caregivers -->
            <div class="card" style="margin-bottom: var(--space-2xl);">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">Active Caregivers</h3>
                    <span class="badge badge-primary" id="activeCount">0</span>
                </div>
                <div id="activeCaregivers"></div>
            </div>

            <!-- Pending Invitations -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">Pending Invitations</h3>
                    <span class="badge badge-warning" id="pendingCount">0</span>
                </div>
                <div id="pendingInvitations"></div>
            </div>
        </div>
    </main>

    <!-- Revoke Confirmation Modal -->
    <div id="revokeModal" class="modal-backdrop" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Revoke Access</h3>
                <button class="modal-close" onclick="closeRevokeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to revoke access for <strong id="revokeCaregiver"></strong>?</p>
                <p class="text-secondary">They will no longer be able to view your risk assessment results.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeRevokeModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmRevokeBtn">Revoke Access</button>
            </div>
        </div>
    </div>

    <script src="../../js/config.js"></script>
    <script src="../../js/storage.js"></script>
    <script src="../../js/api-backend.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/navigation.js"></script>

    <script>
        // Require authentication
        Auth.requireRole('patient');

        const user = Auth.getCurrentUser();
        Navigation.displayUserInfo(user);
        Navigation.setActiveNav();

        document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());

        // Load family access data from backend
        async function loadFamilyAccess() {
            try {
                const data = await API.getCaregiversForPatient(user.id);
                
                const active = data.caregivers.filter(c => c.status === 'active');
                const pending = data.caregivers.filter(c => c.status === 'pending');

                document.getElementById('activeCount').textContent = active.length;
                document.getElementById('pendingCount').textContent = pending.length;

                displayCaregivers(active, 'activeCaregivers', true);
                displayCaregivers(pending, 'pendingInvitations', false);
            } catch (error) {
                console.error('Error loading family access:', error);
                document.getElementById('activeCount').textContent = '0';
                document.getElementById('pendingCount').textContent = '0';
                displayCaregivers([], 'activeCaregivers', true);
                displayCaregivers([], 'pendingInvitations', false);
            }
        }

        function displayCaregivers(caregivers, containerId, isActive) {
            const container = document.getElementById(containerId);

            if (caregivers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-xl);">
                        <div class="empty-state-icon">${isActive ? 'üë®‚Äçüë©‚Äçüëß' : 'üì®'}</div>
                        <div class="empty-state-description">${isActive ? 'No active caregivers yet' : 'No pending invitations'}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = caregivers.map(caregiver => {
                const firstName = caregiver.caregiver_first_name || '';
                const lastName = caregiver.caregiver_last_name || '';
                const caregiverName = `${firstName} ${lastName}`.trim() || caregiver.caregiver_email;
                
                const initials = firstName && lastName 
                    ? `${firstName[0]}${lastName[0]}`.toUpperCase()
                    : caregiver.caregiver_email.substring(0, 2).toUpperCase();

                const relationshipLabel = {
                    'spouse': 'Spouse', 'child': 'Son/Daughter', 'parent': 'Parent',
                    'sibling': 'Sibling', 'grandchild': 'Grandchild', 'other': 'Other Family',
                    'caregiver': 'Professional Caregiver'
                }[caregiver.relationship] || caregiver.relationship;

                const createdDate = new Date(caregiver.created_at).toLocaleDateString();

                return `
                    <div class="family-card">
                        <div class="family-info">
                            <div class="family-avatar">${initials}</div>
                            <div class="family-details">
                                <h4>${caregiverName}</h4>
                                <div class="family-meta">
                                    <span>üìß ${caregiver.caregiver_email}</span>
                                    <span>üë§ ${relationshipLabel}</span>
                                    <span>üìÖ Added ${createdDate}</span>
                                </div>
                                <div class="permissions-list">
                                    <span class="permission-tag">‚úì View Risk Results</span>
                                    <span class="permission-tag">‚úì View Assessment History</span>
                                    <span class="permission-tag">‚úó No Genetic Data Access</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <span class="status-badge status-${caregiver.status}">
                                ${caregiver.status === 'active' ? '‚óè Active' : '‚óã Pending'}
                            </span>
                            ${isActive ? `
                                <button class="btn btn-ghost btn-sm" onclick="showRevokeModal('${caregiver.id}', '${caregiverName.replace(/'/g, "\\'")}')">Revoke</button>
                            ` : `
                                <button class="btn btn-ghost btn-sm" onclick="cancelInvitation('${caregiver.id}')">Cancel</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showError(message) {
            const errorEl = document.getElementById('formError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            document.getElementById('formError').classList.remove('show');
        }

        // Add Caregiver Form
        document.getElementById('addCaregiverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();

            const email = document.getElementById('caregiverEmail').value.trim();
            const relationship = document.getElementById('relationship').value;
            const submitBtn = document.getElementById('submitBtn');

            if (!email || !relationship) {
                showError('Please fill in all fields');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                // First check if caregiver exists
                const checkResult = await API.checkCaregiverByEmail(email);

                if (!checkResult.found) {
                    showError(checkResult.message || 'We could not find any caregivers with that email. Please check that your entered email is correct.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ûï Send Invitation';
                    return;
                }

                // Send invitation
                await API.inviteCaregiver({
                    patientId: user.id,
                    caregiverEmail: email,
                    relationship: relationship
                });

                document.getElementById('addCaregiverForm').reset();
                await loadFamilyAccess();
                UI.showAlert(`Invitation sent to ${email}. They will see your request in their dashboard.`, 'success');

            } catch (error) {
                console.error('Error sending invitation:', error);
                showError(error.message || 'Failed to send invitation. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‚ûï Send Invitation';
            }
        });

        // Revoke Modal
        let revokeAccessId = null;

        function showRevokeModal(accessId, caregiverName) {
            revokeAccessId = accessId;
            document.getElementById('revokeCaregiver').textContent = caregiverName;
            document.getElementById('revokeModal').style.display = 'flex';
        }

        function closeRevokeModal() {
            revokeAccessId = null;
            document.getElementById('revokeModal').style.display = 'none';
        }

        document.getElementById('confirmRevokeBtn').addEventListener('click', async () => {
            if (!revokeAccessId) return;

            try {
                await API.revokeCaregiverAccess(revokeAccessId, user.id);
                UI.showAlert('Access has been revoked', 'success');
                await loadFamilyAccess();
            } catch (error) {
                console.error('Error revoking access:', error);
                UI.showAlert('Failed to revoke access: ' + error.message, 'error');
            }
            closeRevokeModal();
        });

        async function cancelInvitation(accessId) {
            if (!confirm('Are you sure you want to cancel this invitation?')) return;

            try {
                await API.cancelCaregiverInvitation(accessId, user.id);
                UI.showAlert('Invitation cancelled', 'success');
                await loadFamilyAccess();
            } catch (error) {
                console.error('Error cancelling invitation:', error);
                UI.showAlert('Failed to cancel invitation: ' + error.message, 'error');
            }
        }

        document.getElementById('revokeModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-backdrop')) closeRevokeModal();
        });

        // Initial load
        loadFamilyAccess();
    </script>
</body>
</html>