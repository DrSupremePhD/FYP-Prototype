<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - PrivaGene</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/components.css">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="javascript:void(0)"
                style="display: flex; align-items: center; gap: var(--space-sm); text-decoration: none; cursor: default;">
                <span style="font-size: var(--text-3xl);">üß¨</span>
                <span style="font-size: var(--text-xl); font-weight: 700; color: var(--primary-color);">PrivaGene</span>
            </a>
        </div>

        <div
            style="margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <div style="font-weight: 600; margin-bottom: var(--space-xs);" data-user-name>Admin</div>
            <div style="font-size: var(--text-sm); color: var(--text-tertiary);" data-user-email>admin@hospital.com
            </div>
        </div>

        <nav>
            <ul class="sidebar-menu">
                <li class="sidebar-item"><a href="dashboard.html" class="sidebar-link"><span
                            class="sidebar-link-icon">üìä</span>Dashboard</a></li>
                <li class="sidebar-item"><a href="disease-management.html" class="sidebar-link"><span
                            class="sidebar-link-icon">üß¨</span>Disease Database</a></li>
                <li class="sidebar-item"><a href="register-hospital-specialist.html" class="sidebar-link"><span
                            class="sidebar-link-icon">üßë‚Äç‚öïÔ∏è</span>Create Specialist Account</a></li>
                <li class="sidebar-item"><a href="profile.html" class="sidebar-link"><span
                            class="sidebar-link-icon">üë§</span>Profile</a></li>
            </ul>
        </nav>

        <div style="margin-top: auto;"><button id="logout-btn" class="sidebar-link"
                style="width: 100%; border: none; background: transparent; cursor: pointer;"><span
                    class="sidebar-link-icon">üö™</span>Logout</button></div>
    </aside>

    <!-- Main Content -->
    <main class="main-with-sidebar">
        <div class="container-fluid">
            <div style="margin-bottom: var(--space-2xl);">
                <h1 style="font-size: var(--text-4xl); font-weight: 700; margin-bottom: var(--space-sm);">Profile
                    Settings</h1>
                <p class="text-secondary">Manage your admin account information</p>
            </div>

            <!-- Admin Information -->
            <div class="card" style="margin-bottom: var(--space-xl);">
                <div class="card-header">
                    <h3 class="card-title">Admin Information</h3>
                </div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="grid grid-cols-2 gap-lg">
                            <div class="form-group">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" id="firstName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" id="lastName" class="form-input" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" class="form-input" disabled>
                        </div>

                        <div class="form-group">
                            <label for="organization" class="form-label">Organization</label>
                            <input type="text" id="organization" class="form-input">
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- Change Password -->
            <div class="card" style="margin-bottom: var(--space-xl);">
                <div class="card-header">
                    <h3 class="card-title">Change Password</h3>
                </div>
                <div class="card-body">
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" id="currentPassword" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" id="newPassword" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </form>
                </div>
            </div>

            <!-- Deactivate Account -->
            <div class="card" style="border: 1px solid var(--warning-color); margin-bottom: var(--space-xl);">
                <div class="card-header">
                    <h3 class="card-title" style="color: var(--warning-color);">Deactivate Account</h3>
                </div>

                <div style="padding: var(--space-lg);">
                    <p class="text-secondary" style="margin-bottom: var(--space-md);">
                        Temporarily deactivate your account. Your data will be preserved and you can reactivate later by contacting the system administrator.
                    </p>
                    <button onclick="deactivateAccount()" class="btn" style="background: var(--warning-color); color: white;">Deactivate Account</button>
                </div>
            </div>

            <!-- Delete Account -->
            <div class="card" style="border: 1px solid var(--error-color);">
                <div class="card-header">
                    <h3 class="card-title" style="color: var(--error-color);">Delete Account</h3>
                </div>

                <div style="padding: var(--space-lg);">
                    <p class="text-secondary" style="margin-bottom: var(--space-md);">
                        Once you delete your account, all your data will be permanently removed. This cannot be undone.
                    </p>
                    <button onclick="deleteAccount()" class="btn btn-danger">Delete Account</button>
                </div>
            </div>
        </div>
    </main>

    <script src="../../js/config.js"></script>
    <script src="../../js/storage.js"></script>
    <script src="../../js/api-backend.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/navigation.js"></script>

    <script>
        // Allow both 'admin' and 'hospital_admin' roles
        const user = Auth.getCurrentUser();
        if (!user || (user.role !== 'admin' && user.role !== 'hospital_admin')) {
            Auth.requireAuth();
            if (user) Auth.redirectToDashboard(user);
        }
        Navigation.displayUserInfo(user);
        Navigation.setActiveNav();

        document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());

        // Load user data (handle both camelCase and snake_case)
        document.getElementById('firstName').value = user.firstName || user.first_name || '';
        document.getElementById('lastName').value = user.lastName || user.last_name || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('organization').value = user.organizationName || user.organization_name || user.organization || '';

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const updates = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                organizationName: document.getElementById('organization').value.trim()
            };

            UI.showLoading('Saving...');
            try {
                // Update user profile via API
                const updatedUser = await API.updateUser(user.id, updates);
                
                // Update session storage with new data
                const currentUser = Auth.getCurrentUser();
                const mergedUser = { 
                    ...currentUser, 
                    firstName: updates.firstName,
                    first_name: updates.firstName,
                    lastName: updates.lastName,
                    last_name: updates.lastName,
                    organizationName: updates.organizationName,
                    organization_name: updates.organizationName
                };
                sessionStorage.setItem('currentUser', JSON.stringify(mergedUser));
                
                // Update displayed user info
                Navigation.displayUserInfo(mergedUser);
                
                UI.hideLoading();
                UI.showAlert('Profile updated successfully', 'success');
            } catch (error) {
                UI.hideLoading();
                UI.showAlert(error.message || 'Failed to update profile', 'error');
            }
        });

        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                UI.showAlert('New passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                UI.showAlert('Password must be at least 6 characters', 'error');
                return;
            }

            UI.showLoading('Updating password...');
            try {
                // Verify current password and update
                await Auth.updatePassword(currentPassword, newPassword);
                UI.hideLoading();
                UI.showAlert('Password updated successfully', 'success');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                UI.hideLoading();
                UI.showAlert(error.message || 'Failed to update password', 'error');
            }
        });

        // Deactivate account function
        async function deactivateAccount() {
            const confirmed = await UI.confirm(
                'Are you sure you want to deactivate your account? You will be logged out and will need to contact the system administrator to reactivate your account.'
            );

            if (!confirmed) return;

            UI.showLoading('Deactivating account...');

            try {
                // Update user status to 'inactive' via API
                await API.updateUserStatus(user.id, 'inactive');
                
                UI.hideLoading();
                UI.showAlert('Account deactivated. Redirecting...', 'info');

                setTimeout(() => {
                    Auth.logout();
                }, 2000);

            } catch (error) {
                UI.hideLoading();
                UI.showAlert(error.message || 'Failed to deactivate account', 'error');
            }
        }

        // Delete account function
        async function deleteAccount() {
            const confirmed = await UI.confirm(
                'Are you absolutely sure you want to delete your account? This action cannot be undone and all your data will be permanently deleted.'
            );

            if (!confirmed) return;

            const doubleConfirm = await UI.confirm(
                'This is your last chance. Are you really sure?'
            );

            if (!doubleConfirm) return;

            UI.showLoading('Deleting account...');

            try {
                // Delete user account via API
                await API.deleteUser(user.id);
                
                UI.hideLoading();
                UI.showAlert('Account deleted. Redirecting...', 'info');

                setTimeout(() => {
                    Auth.logout();
                }, 2000);

            } catch (error) {
                UI.hideLoading();
                UI.showAlert(error.message || 'Failed to delete account', 'error');
            }
        }

        // Make functions globally available
        window.deactivateAccount = deactivateAccount;
        window.deleteAccount = deleteAccount;
    </script>
</body>

</html>