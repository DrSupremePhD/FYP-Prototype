<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Patients - PrivaGene Caregiver</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/components.css">

    <style>
        .patient-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            transition: background var(--transition-fast);
            cursor: pointer;
        }

        .patient-list-item:hover { background: var(--bg-tertiary); }
        .patient-list-item:last-child { border-bottom: none; }

        .patient-info {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .patient-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-lg);
            color: white;
            font-weight: 600;
        }

        .patient-details h4 {
            font-size: var(--text-base);
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .patient-meta {
            font-size: var(--text-sm);
            color: var(--text-tertiary);
        }

        .search-box {
            position: relative;
            margin-bottom: var(--space-xl);
        }

        .search-box input { padding-left: var(--space-3xl); }

        .search-icon {
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../../index.html" style="display: flex; align-items: center; gap: var(--space-sm); text-decoration: none;">
                <span style="font-size: var(--text-3xl);">ğŸ§¬</span>
                <span style="font-size: var(--text-xl); font-weight: 700; color: var(--primary-color);">PrivaGene</span>
            </a>
        </div>

        <div style="margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <div style="font-weight: 600; margin-bottom: var(--space-xs);" data-user-name>User</div>
            <div style="font-size: var(--text-sm); color: var(--text-tertiary);" data-user-email>user@example.com</div>
            <div style="margin-top: var(--space-sm);"><span class="badge badge-info">Caregiver</span></div>
        </div>

        <nav>
            <ul class="sidebar-menu">
                <li class="sidebar-item"><a href="dashboard.html" class="sidebar-link"><span class="sidebar-link-icon">ğŸ“Š</span> Dashboard</a></li>
                <li class="sidebar-item"><a href="my-patients.html" class="sidebar-link"><span class="sidebar-link-icon">ğŸ‘¥</span> My Patients</a></li>
                <li class="sidebar-item"><a href="profile.html" class="sidebar-link"><span class="sidebar-link-icon">ğŸ‘¤</span> Profile</a></li>
            </ul>
        </nav>

        <div style="margin-top: auto;">
            <button id="logout-btn" class="sidebar-link" style="width: 100%; border: none; background: transparent; cursor: pointer;">
                <span class="sidebar-link-icon">ğŸšª</span> Logout
            </button>
        </div>
    </aside>

    <main class="main-with-sidebar">
        <div class="container-fluid">
            <div style="margin-bottom: var(--space-xl);">
                <h1 style="font-size: var(--text-4xl); font-weight: 700; margin-bottom: var(--space-sm);">My Patients</h1>
                <p class="text-secondary">View and manage patients you're caring for</p>
            </div>

            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="form-input" placeholder="Search patients...">
            </div>

            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">All Patients</h3>
                    <span class="badge badge-primary" id="patientCount">0</span>
                </div>
                <div id="patientsList"></div>
            </div>
        </div>
    </main>

    <script src="../../js/config.js"></script>
    <script src="../../js/storage.js"></script>
    <script src="../../js/api-backend.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/navigation.js"></script>

    <script>
        Auth.requireRole('caregiver');

        const user = Auth.getCurrentUser();
        Navigation.displayUserInfo(user);
        Navigation.setActiveNav();

        document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());

        async function loadUserName() {
            try {
                const fullUser = await API.getUserById(user.id);
                const firstName = fullUser.first_name || fullUser.firstName;
                const lastName = fullUser.last_name || fullUser.lastName;
                
                const userName = firstName && lastName 
                    ? `${firstName} ${lastName}`
                    : firstName || lastName || user.email.split('@')[0];
                
                // Update all elements with data-user-name attribute
                document.querySelectorAll('[data-user-name]').forEach(el => {
                    el.textContent = userName;
                });
            } catch (error) {
                console.error('Error loading user name:', error);
                // Fallback to email prefix if fetch fails
                document.querySelectorAll('[data-user-name]').forEach(el => {
                    el.textContent = user.email.split('@')[0];
                });
            }
        }

        // Update email display in sidebar
        const emailEl = document.querySelector('[data-user-email]');
        if (emailEl) {
            emailEl.textContent = user.email;
        }


        // Load user name from backend
        loadUserName();

        let allPatients = [];

        const relationshipLabels = {
            'spouse': 'ğŸ’‘ Spouse', 'child': 'ğŸ‘¶ Your Parent', 'parent': 'ğŸ‘´ Your Child',
            'sibling': 'ğŸ‘« Sibling', 'grandchild': 'ğŸ‘´ Grandchild', 'other': 'ğŸ‘ª Family',
            'caregiver': 'ğŸ¥ Patient'
        };

        async function loadPatients() {
            try {
                const data = await API.getPatientsForCaregiver(user.id, 'active');
                allPatients = data.patients || [];
                document.getElementById('patientCount').textContent = allPatients.length;
                displayPatients(allPatients);
            } catch (error) {
                console.error('Error loading patients:', error);
                allPatients = [];
                document.getElementById('patientCount').textContent = '0';
                displayPatients([]);
            }
        }

        function displayPatients(patients) {
            const container = document.getElementById('patientsList');

            if (patients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-3xl);">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div class="empty-state-description">
                            No patients found. Ask your family members to add you as a caregiver.
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = patients.map(patient => {
                const firstName = patient.patient_first_name || '';
                const lastName = patient.patient_last_name || '';
                const patientName = `${firstName} ${lastName}`.trim() || patient.patient_email;
                const initials = firstName && lastName 
                    ? `${firstName[0]}${lastName[0]}`.toUpperCase()
                    : patient.patient_email.substring(0, 2).toUpperCase();
                const relationship = relationshipLabels[patient.relationship] || 'ğŸ‘ª Family';
                const accessDate = new Date(patient.accepted_at || patient.created_at).toLocaleDateString();

                return `
                    <div class="patient-list-item" onclick="viewPatient('${patient.patient_id}')">
                        <div class="patient-info">
                            <div class="patient-avatar">${initials}</div>
                            <div class="patient-details">
                                <h4>${patientName}</h4>
                                <div class="patient-meta">
                                    ${relationship} â€¢ Access since ${accessDate}
                                </div>
                            </div>
                        </div>
                        <span style="color: var(--text-tertiary);">â†’</span>
                    </div>
                `;
            }).join('');
        }

        function viewPatient(patientId) {
            window.location.href = `patient-view.html?patientId=${patientId}`;
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allPatients.filter(p => {
                const name = `${p.patient_first_name || ''} ${p.patient_last_name || ''}`.toLowerCase();
                const email = (p.patient_email || '').toLowerCase();
                return name.includes(query) || email.includes(query);
            });
            displayPatients(filtered);
            document.getElementById('patientCount').textContent = filtered.length;
        });

        loadPatients();
    </script>
</body>
</html>